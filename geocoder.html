<!DOCTYPE html>
<head>
    <title>Geocoder</title>
    <link href="../Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script type="text/javascript" src="./js/require.min.js" data-main="./js/main"></script>
    <script type="text/javascript" src="./js/gps.js"></script>
</head>
<body>
<div id="cesiumContainer"></div>
<script>
    function onload(Cesium) {
        function cancelGeocode(viewModel) {
            viewModel._isSearchInProgress = false;
            if (Cesium.defined(viewModel._geocodeInProgress)) {
                viewModel._geocodeInProgress.cancel = true;
                viewModel._geocodeInProgress = undefined;
            }
        }

        function updateCamera(viewModel, destination) {
            viewModel._scene.camera.flyTo({
                destination : destination,
                complete: function() {
                    viewModel._complete.raiseEvent();
                },
                duration : viewModel._flightDuration,
                endTransform : Cesium.Matrix4.IDENTITY
            });
        }

        function geocode(viewModel) {
            var query = viewModel.searchText;

            if (/^\s*$/.test(query)) {
                //whitespace string
                return;
            }

            // If the user entered (longitude, latitude, [height]) in degrees/meters,
            // fly without calling the geocoder.
            var splitQuery = query.match(/[^\s,\n]+/g);
            if ((splitQuery.length === 2) || (splitQuery.length === 3)) {
                var longitude = +splitQuery[0];
                var latitude = +splitQuery[1];

                var obj = GPS.gcj_decrypt_exact(latitude,longitude);
                var height = (splitQuery.length === 3) ? +splitQuery[2] : 300.0;

                if (!isNaN(longitude) && !isNaN(latitude) && !isNaN(height)) {
                    updateCamera(viewModel, Cesium.Cartesian3.fromDegrees(obj.lon,obj.lat, height));
                    return;
                }
            }
            viewModel._isSearchInProgress = true;

            var smPOI = 'http://www.supermapol.com/iserver/services/localsearch/rest/searchdatas/China/poiinfos.rjson';
            var promise = Cesium.loadJsonp(smPOI, {
                parameters : {
                    keywords : query,
                    location : '',
                    radius : '',
                    leftLocation : '',
                    rightLocation : '',
                    pageSize : 50,
                    pageNum : 1
                },
                callbackParameterName : 'callback',
                jsonpName : 'callBack'
            });

            var geocodeInProgress = viewModel._geocodeInProgress = Cesium.when(promise, function(result) {
                if (geocodeInProgress.cancel) {
                    return;
                }
                viewModel._isSearchInProgress = false;

                if (result.resourceSets.length === 0) {
                    viewModel.searchText = viewModel._searchText + ' (not found)';
                    return;
                }

                var resourceSet = result.resourceSets[0];
                if (resourceSet.resources.length === 0) {
                    viewModel.searchText = viewModel._searchText + ' (not found)';
                    return;
                }

                var resource = resourceSet.resources[0];

                viewModel._searchText = resource.name;
                var bbox = resource.bbox;
                var south = bbox[0];
                var west = bbox[1];
                var north = bbox[2];
                var east = bbox[3];

                updateCamera(viewModel, Cesium.Rectangle.fromDegrees(west, south, east, north));
            }, function() {
                if (geocodeInProgress.cancel) {
                    return;
                }

                viewModel._isSearchInProgress = false;
                viewModel.searchText = viewModel._searchText + ' (error)';
            });
        }

        var viewer = new Cesium.Viewer('cesiumContainer');

        var geocoder = viewer.geocoder.viewModel;

        geocoder._searchCommand = Cesium.createCommand(function() {
            if (geocoder.isSearchInProgress) {
                cancelGeocode(geocoder);
            } else {
                geocode(geocoder);
            }
        });
    }
</script>
</body>